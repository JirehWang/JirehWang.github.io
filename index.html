<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>â›ª æ•™æœƒç®¡ç†ç³»çµ± - GitHub å¿«é€Ÿæƒæç‰ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* å…¨åŸŸæ¨£å¼å„ªåŒ– */
    body { background-color: #f4f7f6; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
    .app-container { width: 100%; padding: 15px; margin: 0 auto; max-width: 600px; }
    .nav-card { cursor: pointer; transition: 0.3s; height: 85px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .nav-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .page-section { display: none; }
    
    /* ç›¸æ©Ÿæƒæå™¨æ¨£å¼ */
    #reader-wrapper { border-radius: 15px; overflow: hidden; display: none; margin-bottom: 15px; border: 4px solid #0d6efd; background: #000; }
    .attendance-scroll-area { height: calc(100vh - 350px); overflow-y: auto; background: #fff; border-radius: 12px; padding: 10px; border: 1px solid #ddd; }
    
    /* é»åå¡ç‰‡æ¨£å¼ (èˆ‡æ‚¨åŸæœ¬ä¸€è‡´) */
    #attendanceListBody { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
    .att-item { background: white; border: 1px solid #eee; border-radius: 8px; padding: 8px 4px; text-align: center; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .att-item.selected { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    .att-item.submitted { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
  </style>
</head>
<body>

<div class="app-container">
  <div id="main-nav">
    <h2 class="fw-bold text-center mt-4 mb-4">â›ª æ•™æœƒé»åç³»çµ±</h2>
    <div class="card nav-card text-primary mb-3" onclick="showPage('ATTENDANCE')">ğŸ¤ é–‹å§‹ä¸»æ—¥é»å</div>
    <div class="card nav-card text-secondary mb-3" onclick="showPage('MEMBERS')">ğŸ‘¥ æœƒå‹åå–®ç®¡ç†</div>
    <div class="card nav-card text-success mb-3" onclick="showPage('STATS')">ğŸ“Š å‡ºå¸­çµ±è¨ˆæŸ¥è©¢</div>
  </div>

  <div id="content-area" style="display:none;">
    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goHome()">â† å›ä¸»é¸å–®</button>

    <div id="page-ATTENDANCE" class="page-section">
      <div class="card p-3 shadow-sm border-0">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0">å¿«é€Ÿå ±åˆ°</h5>
          <button id="scanBtn" class="btn btn-primary btn-sm" onclick="toggleScanner()">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
        </div>
        
        <div id="reader-wrapper"><div id="reader"></div></div>

        <div class="attendance-scroll-area">
          <div id="attendanceListBody">
            <p class="text-center p-5 text-muted">æ­£åœ¨é€£ç·šè‡³ Google è©¦ç®—è¡¨...</p>
          </div>
        </div>
        
        <button class="btn btn-success w-100 mt-3 fw-bold py-2" onclick="submitAttendance()">ç¢ºèªé€å‡ºç´€éŒ„</button>
      </div>
    </div>

    <div id="page-MEMBERS" class="page-section"><h4>æœƒå‹ç®¡ç†ä»‹é¢ (é–‹ç™¼ä¸­)</h4></div>
    <div id="page-STATS" class="page-section"><h4>çµ±è¨ˆçµ±è¨ˆä»‹é¢ (é–‹ç™¼ä¸­)</h4></div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  /* ---------------------------------------------------------
     æ ¸å¿ƒ API æ©‹æ¨‘ï¼šé€£æ¥ GitHub åˆ°æ‚¨çš„ Google è©¦ç®—è¡¨
     --------------------------------------------------------- */
  const GAS_URL = "https://script.google.com/macros/s/AKfycbw3Tx8_F5WqHpnA266O0QlbYROj0fY6z34AEWf7xzBpbFu36MDrvAuIRJS84dHhIWs4SQ/exec";
  
  let attUserId = localStorage.getItem('att_uid') || ('User_' + Math.floor(Math.random() * 1000000));
  localStorage.setItem('att_uid', attUserId);
  let html5QrCode = null;

  // å°è£ Fetch APIï¼šåƒæ‰“é›»è©±ä¸€æ¨£å‘¼å« GAS
  async function callGAS(action, params = {}) {
    const queryParams = new URLSearchParams({ action, ...params }).toString();
    try {
      // é€™è£¡ä½¿ç”¨äº† CORS æ¨¡å¼ï¼Œè®“ GitHub èƒ½è·¨ç¶²åŸŸæŠ“å– Google è³‡æ–™
      const response = await fetch(`${GAS_URL}?${queryParams}`);
      return await response.json();
    } catch (err) {
      console.error("é€£ç·šå¤±æ•—:", err);
      return { status: "error", message: "ç„¡æ³•é€£ç·šè‡³ Google ä¼ºæœå™¨" };
    }
  }

  /* ---------------------------------------------------------
     é é¢æ§åˆ¶é‚è¼¯
     --------------------------------------------------------- */
  function showPage(pageId) {
    document.getElementById('main-nav').style.display = 'none';
    document.getElementById('content-area').style.display = 'block';
    document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none');
    document.getElementById('page-' + pageId).style.display = 'block';
    
    if (pageId === 'ATTENDANCE') loadAttendanceData();
  }

  function goHome() {
    if (html5QrCode) stopScanning();
    document.getElementById('main-nav').style.display = 'block';
    document.getElementById('content-area').style.display = 'none';
  }

  /* ---------------------------------------------------------
     é»åç³»çµ±é‚è¼¯ (API ç‰ˆ)
     --------------------------------------------------------- */
  async function loadAttendanceData() {
    const listBody = document.getElementById('attendanceListBody');
    listBody.innerHTML = '<p class="text-center p-5">â³ åå–®è¼‰å…¥ä¸­...</p>';
    
    const res = await callGAS('getAttendanceList', { type: 'å°èª', uid: attUserId });
    
    if (res.status === "success") {
      renderList(res.activeList);
    } else {
      listBody.innerHTML = `<p class="text-danger p-5">âŒ è¼‰å…¥å¤±æ•—: ${res.message}</p>`;
    }
  }

  function renderList(list) {
    const body = document.getElementById('attendanceListBody');
    body.innerHTML = list.map(m => `
      <div class="att-item ${m.isSubmitted ? 'submitted' : (m.isChecked ? 'selected' : '')}" 
           onclick="handleItemClick(this, '${m.name}')">
        <div>${m.name}</div>
        <small>${m.gender}</small>
      </div>
    `).join('');
  }

  async function handleItemClick(element, name) {
    const isNowChecked = !element.classList.contains('selected');
    element.classList.toggle('selected');
    
    // å³æ™‚å‚³å› GAS åŒæ­¥ (å¤šäººå”ä½œ)
    await callGAS('syncClickToServer', { name, isChecked: isNowChecked, type: 'å°èª', userId: attUserId });
  }

  /* ---------------------------------------------------------
     ğŸ“· ç›¸æ©Ÿæƒæé‚è¼¯ (åœ¨ GitHub ä¸‹å°‡ 100% é †æš¢)
     --------------------------------------------------------- */
  function toggleScanner() {
    const wrapper = document.getElementById('reader-wrapper');
    if (wrapper.style.display === 'none') {
      wrapper.style.display = 'block';
      startScanning();
    } else {
      stopScanning();
      wrapper.style.display = 'none';
    }
  }

  function startScanning() {
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      const cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
      html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, (text) => {
        // æƒææˆåŠŸå¾Œçš„é‚è¼¯
        console.log("æƒåˆ° QR:", text);
        // æ‚¨å¯ä»¥åœ¨æ­¤å‘¼å«è‡ªå‹•å‹¾é¸é‚è¼¯
      });
    }).catch(err => alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err));
  }

  function stopScanning() {
    if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
  }
</script>

</body>
</html>
