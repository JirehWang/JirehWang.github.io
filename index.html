<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•™æœƒäº‹å·¥ç®¡ç†ç³»çµ± - ç¶­è­·å¾Œå°</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; user-select: none; }
    .card-custom { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    
    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .table-responsive { max-height: 75vh; overflow: auto; border: 1px solid #dee2e6; position: relative; background: #fff; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    
    /* æ¨™é¡Œåˆ—å›ºå®šä¸”æ¸…æ™° */
    thead th { 
      position: sticky; top: 0; background: #212529 !important; color: white; 
      z-index: 10; padding: 12px; text-align: center; border: 1px solid #373b3e;
    }
    
    /* å„²å­˜æ ¼èˆ‡è¼¸å…¥æ¡† */
    td { border: 1px solid #dee2e6; padding: 0 !important; height: 38px; min-width: 120px; }
    .grid-input { 
      width: 100%; height: 100%; border: none; background: transparent; 
      padding: 8px; text-align: center; outline: none; font-size: 14px; cursor: cell;
    }
    
    /* â˜… Excel é¸å–ç¯„åœæ•ˆæœ */
    .grid-input.selected { background-color: rgba(13, 110, 253, 0.12) !important; }
    .grid-input.active-cell { box-shadow: inset 0 0 0 2px #0d6efd !important; background: white !important; cursor: text; }
    
    #globalLoading { position: fixed; top: 20px; right: 20px; background: #ffc107; padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

  <div id="globalLoading" class="hidden">â³ è™•ç†ä¸­...</div>

  <div class="container-fluid">
    <div id="reportSection" class="card-custom">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 id="groupTitle" class="text-primary m-0 d-inline-block">æ­£åœ¨é€£ç·šè‡³ GAS API...</h4>
          <span class="badge bg-secondary ms-2">ç¶­è­·æ¨¡å¼</span>
        </div>
        <div>
          <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
          <button class="btn btn-outline-secondary ms-2" onclick="location.href='index.html'">å›é¸å–®</button>
        </div>
      </div>
      
      <div class="table-responsive" id="tableContainer">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      
      <div class="mt-3 text-muted small">
        æ“ä½œæç¤ºï¼šæ‹–æ›³æ»‘é¼ å¯<b>å¤šé¸</b>ï½œæŒ‰ Delete <b>æ‰¹æ¬¡åˆªé™¤</b>ï½œCtrl+V <b>ç¯„åœè²¼ä¸Š</b>ï½œé›™æ“Šé€²å…¥<b>æ‰“å­—ç·¨è¼¯</b>
      </div>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbvVZyD_r_LCawhDwfWNqbiagpiU0GksI_Wm3DcD2SLcYJZ5aO_QpQBiHRUzblJYfkL9/exec"; 
  const currentId = new URLSearchParams(window.location.search).get('id');
  let activeGroupName = "";
  
  // é¸å–ç‹€æ…‹ç®¡ç†
  let isMouseDown = false;
  let startCell = {r: null, c: null};
  let endCell = {r: null, c: null};

  window.onload = async () => {
    if (!currentId) {
      document.getElementById('groupTitle').innerText = "è«‹ç”±ç®¡ç†å…¥å£é€²å…¥";
      return;
    }
    await loadTableData();
  };

  async function loadTableData() {
    toggleLoading(true);
    try {
      const res = await fetch(`${GAS_URL}?action=getPageConfig&id=${currentId}`);
      const json = await res.json();
      if (json.status === "success") {
        renderMatrix(json.data);
      } else {
        alert("è®€å–å¤±æ•—ï¼š" + json.message);
      }
    } catch (e) {
      alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
    }
    toggleLoading(false);
  }

  function renderMatrix(data) {
    activeGroupName = data.groupName;
    document.getElementById('groupTitle').innerText = data.groupName;
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    // æ¸²æŸ“æ¨™é¡Œåˆ— (å›ºå®š)
    thead.innerHTML = `<tr>${data.matrix[0].map(h => `<th>${h}</th>`).join('')}</tr>`;
    
    // æ¸²æŸ“è³‡æ–™åˆ— (1-base)
    tbody.innerHTML = data.matrix.slice(1).map((row, rIdx) => {
      const r = rIdx + 1;
      return `<tr>${row.map((cell, cIdx) => `
        <td>
          <input class="grid-input" value="${cell}" 
                 readonly data-r="${r}" data-c="${cIdx}"
                 onmousedown="cellMouseDown(event)" 
                 onmouseenter="cellMouseEnter(event)"
                 ondblclick="cellDblClick(event)">
        </td>`).join('')}</tr>`;
    }).join('');
  }

  // --- Excel ç¯„åœé¸å–é‚è¼¯ ---
  function cellMouseDown(e) {
    isMouseDown = true;
    const r = parseInt(e.target.dataset.r);
    const c = parseInt(e.target.dataset.c);
    startCell = {r, c};
    endCell = {r, c};
    clearSelectionStyles();
    e.target.classList.add('selected', 'active-cell');
  }

  function cellMouseEnter(e) {
    if (!isMouseDown) return;
    const r = parseInt(e.target.dataset.r);
    const c = parseInt(e.target.dataset.c);
    endCell = {r, c};
    drawSelection();
  }

  window.onmouseup = () => { isMouseDown = false; };

  function drawSelection() {
    clearSelectionStyles();
    const minR = Math.min(startCell.r, endCell.r);
    const maxR = Math.max(startCell.r, endCell.r);
    const minC = Math.min(startCell.c, endCell.c);
    const maxC = Math.max(startCell.c, endCell.c);

    document.querySelectorAll('.grid-input').forEach(el => {
      const r = parseInt(el.dataset.r);
      const c = parseInt(el.dataset.c);
      if (r >= minR && r <= maxR && c >= minC && c <= maxC) {
        el.classList.add('selected');
      }
    });
  }

  function clearSelectionStyles() {
    document.querySelectorAll('.grid-input').forEach(el => {
      el.classList.remove('selected', 'active-cell');
      el.readOnly = true;
    });
  }

  function cellDblClick(e) {
    e.target.readOnly = false;
    e.target.focus();
    e.target.classList.add('active-cell');
  }

  // --- éµç›¤æ“ä½œ (Delete, Copy, Paste) ---
  document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const isEditing = active.classList.contains('grid-input') && !active.readOnly;
    if (isEditing) return; 

    const selected = document.querySelectorAll('.grid-input.selected');

    if (e.key === 'Delete' || e.key === 'Backspace') {
      selected.forEach(el => el.value = "");
      e.preventDefault();
    }

    if (e.ctrlKey && e.key === 'c') {
      copySelectionToTSV(selected);
      e.preventDefault();
    }
  });

  function copySelectionToTSV(elements) {
    if (elements.length === 0) return;
    const minR = Math.min(...Array.from(elements).map(el => el.dataset.r));
    const maxR = Math.max(...Array.from(elements).map(el => el.dataset.r));
    const minC = Math.min(...Array.from(elements).map(el => el.dataset.c));
    const maxC = Math.max(...Array.from(elements).map(el => el.dataset.c));

    let tsv = "";
    for (let r = minR; r <= maxR; r++) {
      let rowData = [];
      for (let c = minC; c <= maxC; c++) {
        const el = document.querySelector(`.grid-input[data-r="${r}"][data-c="${c}"]`);
        rowData.push(el ? el.value : "");
      }
      tsv += rowData.join('\t') + "\n";
    }
    navigator.clipboard.writeText(tsv);
  }

  document.addEventListener('paste', (e) => {
    const active = document.activeElement;
    if (!active.classList.contains('grid-input')) return;

    const text = (e.clipboardData || window.clipboardData).getData('text');
    const rows = text.split(/\r?\n/).filter(line => line.length > 0);
    const startR = parseInt(active.dataset.r);
    const startC = parseInt(active.dataset.c);

    rows.forEach((row, i) => {
      const cols = row.split('\t');
      cols.forEach((val, j) => {
        const target = document.querySelector(`.grid-input[data-r="${startR + i}"][data-c="${startC + j}"]`);
        if (target) target.value = val;
      });
    });
    e.preventDefault();
  });

  async function saveData() {
    toggleLoading(true);
    const matrix = [];
    // æŠ“æ¨™é¡Œ
    matrix.push(Array.from(document.querySelectorAll('#tableHead th')).map(th => th.innerText));
    // æŠ“è³‡æ–™
    document.querySelectorAll('#tableBody tr').forEach(tr => {
      matrix.push(Array.from(tr.querySelectorAll('input')).map(input => input.value));
    });

    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: "saveSheetData", data: { groupName: activeGroupName, matrix: matrix } })
      });
      const res = await response.json();
      alert(res.message || "å„²å­˜æˆåŠŸï¼å·²æ›´æ–°è‡³é›²ç«¯çœ‹æ¿ã€‚");
    } catch (e) {
      alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
    }
    toggleLoading(false);
  }

  function toggleLoading(show) {
    document.getElementById('globalLoading').classList.toggle('hidden', !show);
  }
</script>
</body>
</html>
