<style>
  /* è®“è¡¨æ ¼å®¹å™¨é«˜åº¦å›ºå®šï¼Œä¸¦ç”¢ç”Ÿç¨ç«‹æ»¾å‹•æ¢ */
  .member-table-container {
    height: calc(100vh - 200px); 
    overflow: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
  }

  /* è®“è¡¨é ­å›ºå®šåœ¨æœ€ä¸Šæ–¹ (Sticky Header) */
  .member-table-container thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #212529 !important;
    color: white;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
  }

  /* --- âœ… å‡çµç¬¬ä¸€æ¬„ (å§“å) çš„è¨­å®š --- */
  /* å‡çµè¡¨é ­çš„ç¬¬ä¸€å€‹æ¬„ä½ï¼ŒZè»¸è¨­æ›´é«˜é¿å…è¢«è¦†è“‹ */
  .member-table-container thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 11; /* æ¯”ä¸€èˆ¬è¡¨é ­é«˜ */
  }

  /* å‡çµå…§å®¹åˆ—çš„ç¬¬ä¸€å€‹æ¬„ä½ */
  .member-table-container tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 5;
    background-color: #f8f9fa; /* çµ¦ä¸€å€‹å¾®ç°åº•è‰²ï¼Œè“‹æ‰æ»‘éå»çš„å­— */
    border-right: 1px solid #dee2e6; /* åŠ å€‹å³é‚Šæ¡†å€éš” */
    box-shadow: 2px 0 4px -2px rgba(0,0,0,0.1); /* å³å´é™°å½±æå‡ç«‹é«”æ„Ÿ */
  }
</style>

<div class="members-main-wrapper p-2">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="input-group input-group-sm shadow-sm" style="width: 250px;">
      <span class="input-group-text bg-white border-end-0 text-muted">ğŸ”</span>
      <input type="text" id="memberSearchInput" class="form-control border-start-0 border-end-0" 
             placeholder="è¼¸å…¥å§“åå³æ™‚æŸ¥æ‰¾..." oninput="filterMembers()">
      <button id="memberClearBtn" class="btn bg-white border-start-0 text-muted" 
              type="button" onclick="clearMemberSearch()" style="display: none;">âœ•</button>
    </div>
    <button class="btn btn-primary btn-sm shadow-sm px-3" onclick="openMemberModal()">ï¼‹ æ–°å¢æœƒå‹</button>
  </div>

  <div class="member-table-container shadow-sm">
    <table class="table table-hover align-middle mb-0" style="min-width: 800px;"> 
      <thead class="table-dark">
        <tr>
          <th style="width: 110px;">å§“å</th>
          <th style="width: 70px;">æ€§åˆ¥</th>
          <th style="width: 110px;">å»ºç«‹æ—¥æœŸ</th>
          <th>å‚™è¨»</th>
          <th style="width: 90px;">ç‹€æ…‹</th>
          <th style="width: 120px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="memberTableBody">
        <tr><td colspan="6" class="text-center p-5">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="memberListModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; overflow-y: auto;">
  <div class="custom-modal-content" style="background: white; margin: 5% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 15px;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 id="memModalHeader" class="fw-bold mb-0 text-dark">æ–°å¢æœƒå‹è³‡æ–™</h5>
      <button type="button" class="btn-close" onclick="closeMemberModal()"></button>
    </div>
    <hr>
    
    <input type="hidden" id="editOldName_Mem">

    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label fw-bold small text-muted">å§“å</label>
        <input type="text" id="editName_Mem" class="form-control form-control-lg" placeholder="è«‹è¼¸å…¥å§“å">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold small text-muted">æ€§åˆ¥</label>
        <select id="editGender_Mem" class="form-select form-select-lg">
          <option value="ç”·">ç”· ğŸ‘¦</option>
          <option value="å¥³">å¥³ ğŸ‘§</option>
        </select>
      </div>
      <div class="col-12">
        <label class="form-label fw-bold small text-muted">å‚™è¨»</label>
        <textarea id="editNote_Mem" class="form-control" rows="3" placeholder="å…¶ä»–è¯çµ¡è³‡è¨Šæˆ–è¨»è¨˜..."></textarea>
      </div>
      <div class="col-12">
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" id="editIsExcluded_Mem">
          <label class="form-check-label fw-bold" for="editIsExcluded_Mem">ä¸åˆ—å…¥ä¸»æ—¥å‡ºå¸­ç‡çµ±è¨ˆ</label>
          <div class="form-text small text-muted">é–‹å•Ÿå¾Œï¼Œè©²æœƒå‹ä»å¯é»åï¼Œä½†ä¸æœƒè¨ˆç®—åœ¨ç¸½é«”ç™¾åˆ†æ¯”ä¸­ã€‚</div>
        </div>
      </div>
    </div>
    
    <div class="text-end mt-4">
      <button class="btn btn-light px-4 me-2" onclick="closeMemberModal()">å–æ¶ˆ</button>
      <button id="saveMemBtn" class="btn btn-primary px-4 fw-bold" onclick="processMemberSave()">ç¢ºèªå„²å­˜</button>
    </div>
  </div>
</div>

<script>
  let allMembersRawData = [];

  // åˆå§‹åŒ–èˆ‡åˆ·æ–°åˆ—è¡¨
  function refreshMemberTable() {
    const tbody = document.getElementById('memberTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div><br>è³‡æ–™è¼‰å…¥ä¸­...</td></tr>';
    
    google.script.run.withSuccessHandler(function(data) {
      allMembersRawData = data || [];
      renderTable(allMembersRawData);
    }).getAllMembers();
  }

  // æœå°‹éæ¿¾
  function filterMembers() {
    const keyword = document.getElementById('memberSearchInput').value.trim().toLowerCase();
    const clearBtn = document.getElementById('memberClearBtn');
    clearBtn.style.display = keyword ? 'block' : 'none';
    
    if (!keyword) { renderTable(allMembersRawData); return; }
    
    const filtered = allMembersRawData.filter(row => (row[0] || "").toString().toLowerCase().includes(keyword));
    renderTable(filtered);
  }

  function clearMemberSearch() {
    document.getElementById('memberSearchInput').value = '';
    filterMembers();
  }

  // æ¸²æŸ“è¡¨æ ¼
  function renderTable(data) {
    const tbody = document.getElementById('memberTableBody');
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-muted">æŸ¥ç„¡è³‡æ–™</td></tr>';
      return;
    }
    
    let html = '';
    data.forEach(row => {
      if (!row[0]) return; // æ²’åå­—è·³é
      
      const isExcluded = (row[4] === true || row[4] === "TRUE");
      
      let dateStr = row[2];
      if (row[2] && new Date(row[2]) != "Invalid Date") {
         let d = new Date(row[2]);
         dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
      }

      const rowJson = JSON.stringify(row).replace(/'/g, "&#39;");

      html += `<tr>
        <td class="text-dark"><strong>${row[0]}</strong></td>
        <td>${row[1] || ''}</td>
        <td><small class="text-muted">${dateStr || ''}</small></td> 
        <td title="${row[3] || ''}"><div class="text-truncate" style="max-width:150px;">${row[3] || ''}</div></td>
        <td>${isExcluded ? '<span class="badge bg-warning text-dark">ä¸çµ±è¨ˆ</span>' : '<span class="badge bg-success bg-opacity-10 text-success border border-success">æ­£å¸¸</span>'}</td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick='openMemberModal(${rowJson})'>ç·¨è¼¯</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteMemberAction('${row[0]}')">åˆªé™¤</button>
          </div>
        </td>
      </tr>`;
    });
    tbody.innerHTML = html;
  }

  // --- Modal æ§åˆ¶ (å°ˆç”¨) ---
  function openMemberModal(row = null) {
    document.getElementById('memberListModal').style.display = 'block';
    
    if (row) {
      document.getElementById('memModalHeader').innerText = "ç·¨è¼¯æœƒå‹è³‡æ–™";
      document.getElementById('editOldName_Mem').value = row[0]; 
      document.getElementById('editName_Mem').value = row[0];
      document.getElementById('editGender_Mem').value = row[1];
      document.getElementById('editNote_Mem').value = row[3];
      document.getElementById('editIsExcluded_Mem').checked = (row[4] === true || row[4] === "TRUE");
    } else {
      document.getElementById('memModalHeader').innerText = "æ–°å¢æœƒå‹è³‡æ–™";
      document.getElementById('editOldName_Mem').value = ""; 
      document.getElementById('editName_Mem').value = "";
      document.getElementById('editGender_Mem').value = "ç”·";
      document.getElementById('editNote_Mem').value = "";
      document.getElementById('editIsExcluded_Mem').checked = false;
    }
  }

  function closeMemberModal() { document.getElementById('memberListModal').style.display = 'none'; }

  // --- å„²å­˜è³‡æ–™ ---
  function processMemberSave() {
    const oldName = document.getElementById('editOldName_Mem').value;
    const newData = {
      name: document.getElementById('editName_Mem').value.trim(),
      gender: document.getElementById('editGender_Mem').value,
      note: document.getElementById('editNote_Mem').value.trim(),
      isExcluded: document.getElementById('editIsExcluded_Mem').checked
    };

    if (!newData.name) return alert("è«‹è¼¸å…¥å§“å");
    
    const btn = document.getElementById('saveMemBtn');
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

    google.script.run
        .withSuccessHandler(function(msg) {
            alert(msg);
            btn.disabled = false; btn.innerText = originalText;
            if (msg.includes("æˆåŠŸ") || msg.includes("OK")) {
                closeMemberModal();
                refreshMemberTable();
            }
        })
        .updateMember(oldName, newData);
  }

  // --- åˆªé™¤è³‡æ–™ ---
  function deleteMemberAction(name) {
    if (confirm("âš ï¸ ç¢ºå®šåˆªé™¤ [" + name + "] ?\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
      google.script.run.withSuccessHandler(function(msg) {
          alert(msg);
          refreshMemberTable();
      }).deleteMember(name);
    }
  }
</script>
